name: Deploy

on:
  workflow_call:
    inputs:
      app-version:
        required: true
        type: string
      distribution-channel:
        required: true
        type: string

permissions:
  contents: write

defaults:
  run:
    shell: 'bash'

env:
  NODE_NO_WARNINGS: 1
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
  npm_config_audit: false
  npm_config_fund: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: ${{inputs.distribution-channel}}
      url: https://github.com/${{github.repository}}/releases/tag/v${{inputs.app-version}}
    steps:
      - name: Debug - List available artifacts
        run: |
          echo "Looking for artifacts matching pattern: *-${{inputs.distribution-channel}}"
          gh api repos/${{github.repository}}/actions/runs/${{github.run_id}}/artifacts --jq '.artifacts[] | "Name: \(.name), ID: \(.id)"'
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download compiled app
        uses: actions/download-artifact@v6
        with:
          pattern: "*-${{inputs.distribution-channel}}"
          path: dist
          merge-multiple: true

      - name: Debug - List dist contents
        run: |
          echo "Contents of dist directory:"
          ls -laR dist/ || echo "dist directory does not exist"
          echo "Looking for smyles-station files:"
          find dist -name "smyles-station-*" -type f 2>/dev/null || echo "No smyles-station files found"

      - run: gh release create v${{inputs.app-version}} dist/smyles-station-*.* --repo ${{github.repository}}
        env:
          GH_TOKEN: ${{ github.token }}
